name: â¬†ï¸ Auto Sync Upstream

on:
  workflow_dispatch:    # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 0 * * *' # æ¯å¤© 00:00 è§¦å‘ï¼ˆUTC æ—¶é—´ï¼Œ+8 ä¸ºæ—©ä¸Š 8 ç‚¹ï¼‰

jobs:
  auto-sync:
    runs-on: ubuntu-latest

    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }} # ä¾› gh å‘½ä»¤ä½¿ç”¨

    steps:
      # Step 1: æ£€å‡ºç›®æ ‡ä»“åº“ä»£ç 
      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}
          fetch-depth: 0

      # Step 2: æ·»åŠ  upstream ä»“åº“å¹¶æ‹‰å–æ›´æ–°
      - name: Add upstream remote and fetch
        run: |
          git remote add upstream https://github.com/youshandefeiyang/sub-web-modify.git
          git fetch upstream

      # Step 3: åˆ›å»ºæˆ–æ›´æ–° auto-sync-upstream åˆ†æ”¯
      - name: Create auto-sync-upstream branch
        run: |
          git checkout -B auto-sync-upstream
          git reset --hard upstream/master

      # Step 4: è®¾ç½® Git å‡­è¯ä»¥æ”¯æŒæ¨é€
      - name: Set Git credentials
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git remote set-url origin https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/wenwenxxoo/sub-web-modify-fy.git

      # Step 5: å¼ºæ¨åˆ†æ”¯åˆ°ç›®æ ‡ä»“åº“
      - name: Force push sync branch
        run: |
          git checkout -B auto-sync-upstream upstream/master
          git remote set-url origin https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/wenwenxxoo/sub-web-modify-fy.git
          git push origin auto-sync-upstream --force

      # Step 6: åˆ›å»ºæˆ–æ›´æ–° PRï¼ˆè‡ªåŠ¨ mergeï¼‰
      - name: Create or update PR
        uses: repo-sync/pull-request@v2
        with:
          github_token: ${{ secrets.GH_TOKEN }}
          source_branch: auto-sync-upstream
          destination_branch: master
          pr_title: 'ğŸ”„ Sync from upstream'
          pr_body: 'Auto-synced from upstream repo: https://github.com/youshandefeiyang/sub-web-modify'
          pr_allow_empty: false
          pr_draft: false

      # Step 7: ç­‰å¾… PR åˆ›å»ºæˆåŠŸï¼ˆå¯é€‰é˜²æ­¢ PR ä¸å­˜åœ¨ï¼‰
      - name: Wait 5 seconds
        run: sleep 5

      # Step 8: å¼€å¯ PR auto-mergeï¼ˆéœ€è¦ repo è®¾ç½®æ”¯æŒï¼‰
      - name: Enable auto-merge for PR
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.GH_TOKEN }}
          merge-method: squash
          repository: wenwenxxoo/sub-web-modify-fy

      # Step 9: å°è¯•ç«‹å³è§¦å‘åˆå¹¶ï¼ˆå¦‚æœå¯ä»¥çš„è¯ï¼‰
      - name: Try merging the PR
        run: |
          gh pr merge -R "wenwenxxoo/sub-web-modify-fy" --squash --auto --match-head-commit
