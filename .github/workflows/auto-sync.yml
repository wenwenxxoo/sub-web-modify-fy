name: ğŸ”„ Auto Sync from Upstream

# å®šæ—¶è§¦å‘ï¼šæ¯å¤© UTC 2 ç‚¹è¿è¡Œä¸€æ¬¡ï¼ˆå³åŒ—äº¬æ—¶é—´æ—©ä¸Š 10 ç‚¹ï¼‰
on:
  schedule:
    - cron: '0 2 * * *'
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    # è®¾ç½®ç¯å¢ƒå˜é‡ï¼ŒGH_TOKEN ç”¨äº gh cli å’Œ GitHub API æˆæƒæ“ä½œ
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}

    steps:
      # 1. æ£€å‡ºå½“å‰ä»“åº“ä»£ç ï¼ˆwenwenxxoo/sub-web-modify-fyï¼‰
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      # 2. è®¾ç½® Git æäº¤äººèº«ä»½ï¼ˆè‡ªåŠ¨æœºå™¨äººï¼‰
      - name: Set Git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      # 3. æ·»åŠ ä¸Šæ¸¸ä»“åº“ï¼ˆyoushandefeiyang/sub-web-modifyï¼‰ä¸º remoteï¼Œå¹¶æ‹‰å–æœ€æ–°å†…å®¹
      - name: Add upstream remote and fetch
        run: |
          git remote add upstream https://github.com/youshandefeiyang/sub-web-modify.git
          git fetch upstream

      # 4. æ£€æŸ¥ä¸Šæ¸¸æ˜¯å¦æœ‰æ–°æäº¤ï¼ˆHEAD..upstream/masterï¼‰
      - name: Check upstream changes
        id: check
        run: |
          git fetch upstream master
          COMMITS=$(git rev-list HEAD..upstream/master --count)
          echo "commits_ahead=$COMMITS" >> $GITHUB_OUTPUT

      # 5. å¦‚æœæ²¡æœ‰æ–°æäº¤ï¼Œè·³è¿‡åç»­æ­¥éª¤
      - name: No updates, skip sync
        if: steps.check.outputs.commits_ahead == '0'
        run: echo "No updates from upstream."

      # 6. å¦‚æœæœ‰æ–°æäº¤ï¼Œåˆ›å»ºæ–°åˆ†æ”¯ auto-sync-upstream å¹¶å¼ºæ¨åˆ°å½“å‰ä»“åº“
      - name: Create sync branch and push
        if: steps.check.outputs.commits_ahead != '0'
        run: |
          git checkout -B auto-sync-upstream upstream/master
          git remote set-url origin https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git
          git push origin auto-sync-upstream --force

      # 7. ç”Ÿæˆå˜æ›´æ—¥å¿—ï¼ˆç”¨äº PR æè¿°ï¼‰
      - name: Generate commit log
        id: changelog
        if: steps.check.outputs.commits_ahead != '0'
        run: |
          LOG=$(git log --oneline HEAD..upstream/master)
          echo "log<<EOF" >> $GITHUB_OUTPUT
          echo "$LOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # 8. åˆ›å»ºæˆ–æ›´æ–° PRï¼Œbase=masterï¼Œhead=auto-sync-upstream
      - name: Create or update PR
        if: steps.check.outputs.commits_ahead != '0'
        id: create_pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GH_TOKEN }}
          title: "ğŸ”„ Sync from upstream/master"
          body: |
            Detected **${{ steps.check.outputs.commits_ahead }} new commit(s)** from upstream.

            ---
            **Commit log:**
            ```
            ${{ steps.changelog.outputs.log }}
            ```

            _This PR was generated automatically._
          head: auto-sync-upstream
          base: master
          labels: |
            auto-sync
            ready-to-merge

      # 9. å¯ç”¨ PR çš„è‡ªåŠ¨åˆå¹¶åŠŸèƒ½ï¼ˆå‰æï¼šä»“åº“è®¾ç½®ä¸­å…è®¸ auto-mergeï¼‰
      - name: Enable PR auto-merge
        if: steps.check.outputs.commits_ahead != '0'
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.GH_TOKEN }}
          pull-request-number: ${{ steps.create_pr.outputs.pull-request-number }}
          merge-method: squash  # å¯é€‰å€¼è¿˜æœ‰ merge / rebase
