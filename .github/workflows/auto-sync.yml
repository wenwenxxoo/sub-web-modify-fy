# ğŸ“„ .github/workflows/auto-sync.yml
# è‡ªåŠ¨ä» upstream ä»“åº“åŒæ­¥æœ€æ–°ä»£ç ï¼Œæäº¤ PR å¹¶è‡ªåŠ¨åˆå¹¶

name: ğŸ”„ Auto Sync from Upstream

on:
  schedule:
    - cron: '0 2 * * *' # æ¯å¤©åŒ—äº¬æ—¶é—´ 10:00ï¼ˆUTC+8ï¼‰
  workflow_dispatch:   # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  sync:
    runs-on: ubuntu-latest

    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}  # éœ€è¦ä½ åœ¨ä»“åº“ Secrets é‡Œé…ç½®ï¼ŒPATï¼Œéœ€æœ‰ repo æƒé™

    steps:
      # 1. æ£€å‡ºè‡ªå·±çš„ä»£ç åº“ï¼Œä¸è‡ªåŠ¨ä½¿ç”¨é»˜è®¤ token
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      # 2. è®¾ç½®æäº¤èº«ä»½ä¸º github-actions[bot]
      - name: Set Git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      # 3. æ·»åŠ  upstream è¿œç¨‹ä»“åº“å¹¶æ‹‰å–æœ€æ–°æ•°æ®
      - name: Add upstream remote and fetch
        run: |
          git remote add upstream https://github.com/youshandefeiyang/sub-web-modify.git
          git fetch upstream

      # 4. æ£€æŸ¥ upstream/master æ˜¯å¦æœ‰æ–°çš„æäº¤
      - name: Check upstream changes
        id: check
        run: |
          git fetch upstream master
          COMMITS=$(git rev-list HEAD..upstream/master --count)
          echo "commits_ahead=$COMMITS" >> $GITHUB_OUTPUT

      # 5. å¦‚æœæ²¡æœ‰æ–°æäº¤ï¼Œåˆ™è·³è¿‡åç»­æ­¥éª¤
      - name: No updates, skip sync
        if: steps.check.outputs.commits_ahead == '0'
        run: echo "No updates from upstream."

      # 6. æœ‰æ–°æäº¤åˆ™åˆ›å»ºåŒæ­¥åˆ†æ”¯ï¼Œåˆ‡æ¢å¹¶æ¨é€ï¼ˆå¿…é¡»å…ˆæ”¹ origin URL åŠ  tokenï¼‰
      - name: Create sync branch and push
        if: steps.check.outputs.commits_ahead != '0'
        run: |
          git checkout -B auto-sync-upstream upstream/master
          git remote set-url origin https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git
          git push origin auto-sync-upstream --force

      # 7. ç”Ÿæˆ commit æ—¥å¿—ï¼Œç”¨äº PR æè¿°
      - name: Generate commit log
        id: changelog
        if: steps.check.outputs.commits_ahead != '0'
        run: |
          LOG=$(git log --oneline HEAD..upstream/master)
          echo "log<<EOF" >> $GITHUB_OUTPUT
          echo "$LOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # 8. åˆ›å»ºæˆ–æ›´æ–°åŒæ­¥ PR
      - name: Create Pull Request
        if: steps.check.outputs.commits_ahead != '0'
        id: create_pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GH_TOKEN }}
          title: "ğŸ”„ Sync from upstream/master"
          body: |
            Detected **${{ steps.check.outputs.commits_ahead }} new commit(s)** from upstream.

            ---
            **Commit log:**
            ```
            ${{ steps.changelog.outputs.log }}
            ```

            _This PR was generated automatically._
          head: ${{ github.actor }}:auto-sync-upstream
          base: master
          labels: |
            auto-sync
            ready-to-merge
            
      - name: Debug PR existence
        run: gh pr list --head auto-sync-upstream --state open
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          
      # 9. å¯ç”¨ PR è‡ªåŠ¨åˆå¹¶ï¼ˆéœ€è¦ä»“åº“åˆ†æ”¯ä¿æŠ¤å…è®¸ auto-mergeï¼‰
      - name: Enable auto-merge for PR
        if: steps.check.outputs.commits_ahead != '0'
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.GH_TOKEN }}
          pull-request-number: ${{ steps.create_pr.outputs.pull-request-number }}
          merge-method: squash
