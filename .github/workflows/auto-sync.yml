name: ⬆️ Auto Sync Upstream

on:
  workflow_dispatch:    # 支持手动触发
  schedule:
    - cron: '0 0 * * *' # 每天 00:00 触发（UTC 时间，+8 为早上 8 点）

jobs:
  auto-sync:
    runs-on: ubuntu-latest

    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }} # 供 gh 命令使用

    steps:
      # Step 1: 检出目标仓库代码
      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}
          fetch-depth: 0

      # Step 2: 添加 upstream 仓库并拉取更新
      - name: Add upstream remote and fetch
        run: |
          git remote add upstream https://github.com/youshandefeiyang/sub-web-modify.git
          git fetch upstream

      # Step 3: 创建或更新 auto-sync-upstream 分支
      - name: Create auto-sync-upstream branch
        run: |
          git checkout -B auto-sync-upstream
          git reset --hard upstream/master

      # Step 4: 设置 Git 凭证以支持推送
      - name: Set Git credentials
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git remote set-url origin https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/wenwenxxoo/sub-web-modify-fy.git

      # Step 5: 强推分支到目标仓库
      - name: Force push sync branch
        run: |
          git checkout -B auto-sync-upstream upstream/master
          git remote set-url origin https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/wenwenxxoo/sub-web-modify-fy.git
          git push origin auto-sync-upstream --force

      # Step 6: 创建或更新 PR（自动 merge）
      - name: Create or update PR
        uses: repo-sync/pull-request@v2
        with:
          github_token: ${{ secrets.GH_TOKEN }}
          source_branch: auto-sync-upstream
          destination_branch: master
          pr_title: '🔄 Sync from upstream'
          pr_body: 'Auto-synced from upstream repo: https://github.com/youshandefeiyang/sub-web-modify'
          pr_allow_empty: false
          pr_draft: false

      # Step 7: 等待 PR 创建成功（可选防止 PR 不存在）
      - name: Wait 5 seconds
        run: sleep 5

      # Step 8: 开启 PR auto-merge（需要 repo 设置支持）
      - name: Enable auto-merge for PR
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.GH_TOKEN }}
          merge-method: squash
          repository: wenwenxxoo/sub-web-modify-fy

      # Step 9: 尝试立即触发合并（如果可以的话）
      - name: Try merging the PR
        run: |
          gh pr merge -R "wenwenxxoo/sub-web-modify-fy" --squash --auto --match-head-commit
