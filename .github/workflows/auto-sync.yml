name: â¬†ï¸ Auto Sync Upstream

on:
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  # å®šæ—¶è§¦å‘ï¼Œæ¯å¤© UTC æ—¶é—´ 00:00ï¼ˆåŒ—äº¬æ—¶é—´ 8 ç‚¹ï¼‰
  schedule:
    - cron: '0 0 * * *'

jobs:
  auto-sync:
    runs-on: ubuntu-latest

    env:
      # éœ€è¦åœ¨ä»“åº“ Secrets é‡Œé…ç½® GitHub ä¸ªäººè®¿é—®ä»¤ç‰Œï¼ˆPATï¼‰ï¼Œä¸”éœ€æœ‰ repo æƒé™
      GH_TOKEN: ${{ secrets.GH_TOKEN }}

    steps:
      # 1ï¸âƒ£ æ£€å‡ºå½“å‰ä»“åº“å®Œæ•´ä»£ç ï¼ˆå«æ‰€æœ‰åˆ†æ”¯å’Œæäº¤å†å²ï¼‰
      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}
          fetch-depth: 0  # éœ€è¦å®Œæ•´å†å²ï¼Œæ–¹ä¾¿åˆ›å»ºåˆ†æ”¯å’Œæ¯”è¾ƒ

      # 2ï¸âƒ£ æ·»åŠ  upstream è¿œç¨‹ä»“åº“å¹¶æ‹‰å–æœ€æ–°ä»£ç 
      - name: Add upstream remote and fetch
        run: |
          git remote add upstream https://github.com/youshandefeiyang/sub-web-modify.git
          git fetch upstream

      # 3ï¸âƒ£ åˆ›å»ºæˆ–é‡ç½®æœ¬åœ° auto-sync-upstream åˆ†æ”¯åˆ° upstream/master
      - name: Create or reset sync branch
        run: |
          git checkout -B auto-sync-upstream upstream/master

      # 4ï¸âƒ£ é…ç½® Git æäº¤èº«ä»½å’Œ origin è¿œç¨‹ä»“åº“å‡­è¯ï¼ˆç”¨ token æˆæƒæ¨é€ï¼‰
      - name: Set Git credentials
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git remote set-url origin https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/wenwenxxoo/sub-web-modify-fy.git

      # 5ï¸âƒ£ å¼ºåˆ¶æ¨é€ auto-sync-upstream åˆ†æ”¯åˆ°ä½ ä»“åº“çš„ originï¼ˆè¦†ç›–è¿œç¨‹åˆ†æ”¯ï¼‰
      - name: Push sync branch to origin
        run: |
          git push origin auto-sync-upstream --force

      # 6ï¸âƒ£ ä½¿ç”¨ repo-sync/pull-request@v2 åˆ›å»ºæˆ–æ›´æ–° PRï¼Œè‡ªåŠ¨åŒæ­¥ upstream ä»£ç åˆ° master
      - name: Create or update Pull Request
        id: create_pr
        uses: repo-sync/pull-request@v2
        with:
          github_token: ${{ secrets.GH_TOKEN }}
          source_branch: auto-sync-upstream      # æœ¬åœ°åŒæ­¥åˆ†æ”¯
          destination_branch: master             # ç›®æ ‡åˆ†æ”¯
          pr_title: 'ğŸ”„ Sync from upstream'     # PR æ ‡é¢˜
          pr_body: 'Auto-synced from upstream repo: https://github.com/youshandefeiyang/sub-web-modify' # PR æè¿°
          pr_allow_empty: false                  # ä¸å…è®¸ç©ºçš„ PR
          pr_draft: false                       # ä¸æ˜¯è‰ç¨¿ PR

      # 7ï¸âƒ£ ç­‰å¾… 5 ç§’ï¼Œç¡®ä¿ PR åˆ›å»ºå®Œæˆï¼ˆé˜²æ­¢ race conditionï¼‰
      - name: Wait 5 seconds
        run: sleep 5

      # 8ï¸âƒ£ å¯ç”¨è¯¥ PR çš„è‡ªåŠ¨åˆå¹¶åŠŸèƒ½ï¼Œåˆå¹¶æ–¹å¼ä¸º squashï¼ˆéœ€ä»“åº“æ”¯æŒ auto-mergeï¼‰
      - name: Enable auto-merge for PR
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.GH_TOKEN }}
          pull-request-number: ${{ steps.create_pr.outputs.pull-request-number }}
          merge-method: squash
          repository: wenwenxxoo/sub-web-modify-fy

      # 9ï¸âƒ£ å°è¯•ç«‹å³ç”¨ gh CLI è§¦å‘è‡ªåŠ¨åˆå¹¶ï¼ˆç¡®ä¿è‡ªåŠ¨åˆå¹¶èƒ½åŠæ—¶æ‰§è¡Œï¼‰
      - name: Try merging the PR
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          gh pr merge ${{ steps.create_pr.outputs.pull-request-number }} -R "wenwenxxoo/sub-web-modify-fy" --squash --auto --delete-branch
